/**
**===========================================================================
**
**  In this project, you can try some programming yourself.
**  You can use the 16 LEDs and the Sensor for anything you would like to do
**
**===========================================================================
*/


#include "main.h"
#include "stm32f0xx_rcc.h"
#include "drvApa102.h"
#include "drvMMA8653.h"
#include "drvPower.h"
#include "helper.h"


//this sets the period (time between two runs) of the application loop in milli-seconds
#define LOOP_TIMEBASE	100


uint32_t timer=0;
uint8_t  timerFlag=0;
volatile uint32_t delayTimer;

/**
**===========================================================================
**
**  setup: 	You have to add your application's setup code here.
**  		This method is called only once at the very beginning
**
**===========================================================================
*/
void setup(void)
{
	//init the drivers
	power_init();
	apa102_init();

	//LED-Test
	for(uint8_t i = 0; i<16; i++)
	{
		apa102_setSingle(i,10);
		delay(20);
	}
	mma8653_init();
	mma8653_setDataWidth(MMA8653_DATAWIDTH_8);
	mma8653_setDataRate(RATE_400Hz);
	globalColor.red=0x00;
	globalColor.green=0xFF;
	globalColor.blue=0x00;

	apa102_allOff();
}
/**
**===========================================================================
**
**  loop: 	You have to add your application's code here.
**  		This method is called over and over again, until the lightShaker is switched off.
**  		The macro "LOOP_TIMEBASE" defines how often loop is called every second.
**
**===========================================================================
*/

/** The following helper functions are available to control the LEDs and write own programs
** Warten(uint32_t ticks) warte die angegeben Zeit bis zum ausf체hren des n채chsten Kommandos
**
** LedEin(uint8_t ledNummer); schalte die LED mit der angegebenen Nummer ein
**
** LedMusterEin(uint16_t muster); schalte alle LEDs ein, bei denen eine "1" steht. Beispiel: LedMusterEin(0101010101010101) schaltet jede zweite LED ein.
**
** RGBFarbeAendern(uint8_t rot, uint8_t gruen, uint8_t blau); 채ndere die Farbe f체r alle LEDs. Beispiel: RGBFarbeAendern(255,0,0) macht alle LEDs rot.
**
** AktuelleBeschleunigung(); Gibt den aktuellen Wert des Beschleunigungssensor aus
**
** KnightRider(void); demo: Das rote Leuchtband von KIT aus Knight Rider 
**
** FarbenSpiel(void); demo: Schaltet LEDs in verschiedenen Farben ein
*/

void loop(void)
{
	KnightRider();
}
/**
**===========================================================================
**
**  don't change the rest of this File!!
**
**===========================================================================
*/
void SysTick_Handler(void)
{
	if(delayTimer)
	{
		delayTimer--;
	}

	timer++;
	if  (timer>=LOOP_TIMEBASE)
	{
		timerFlag = 1;
		timer = 0;
		power_exec();
	}
}

void delay(uint32_t ticks)
{
	delayTimer = ticks;
	while(delayTimer > 0);
}


int main(void)
{
	SystemInit();
	SystemCoreClockUpdate();
	//the systick timer runs with 6MHz
	//config the timer for 1ms interval
	SysTick_Config(6000);
	setup();

	while(1)
	{
		if(timerFlag)
		{
			timerFlag = 0;
			loop();
		}
	}
  return 0;
}
